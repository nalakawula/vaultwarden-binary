name: Build and Release Vaultwarden Binaries

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  check-version:
    name: Check for New Release
    runs-on: ubuntu-latest
    outputs:
      latest_tag: ${{ steps.get-tag.outputs.tag }}
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Get latest Vaultwarden tag
        id: get-tag
        run: |
          # Use -s for silent and --fail to catch 404s
          TAG=$(curl -sfL https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest | jq -r '.tag_name')
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Check if release exists
        id: check
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ steps.get-tag.outputs.tag }}
        run: |
          # We check if the tag exists. If gh succeeds, release exists.
          if gh release view "$TAG" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "Version $TAG found. Skipping build."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "Version $TAG not found. Proceeding with build."
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi
  build:
    needs: check-version
    if: needs.check-version.outputs.should_run == 'true'
    name: Extract ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: "linux/amd64"
            name: "amd64"
          - platform: "linux/arm64"
            name: "arm64"
          - platform: "linux/arm/v7"
            name: "armv7"
          - platform: "linux/arm/v6"
            name: "armv6"
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Extract Binaries
        run: |
          TAG="${{ needs.check-version.outputs.latest_tag }}"
          docker pull --platform ${{ matrix.platform }} vaultwarden/server:$TAG
          CONTAINER_ID=$(docker create --platform ${{ matrix.platform }} vaultwarden/server:$TAG)
          mkdir -p output
          docker cp $CONTAINER_ID:/vaultwarden output/vaultwarden
          docker cp $CONTAINER_ID:/web-vault output/web-vault
          docker rm $CONTAINER_ID
          cd output && tar -cvzf ../vaultwarden-${{ matrix.name }}.tar.gz .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.name }}
          path: vaultwarden-${{ matrix.name }}.tar.gz
          retention-days: 1

  publish:
    needs: [check-version, build]
    if: needs.check-version.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binary-*
          merge-multiple: true

      - name: Create Release and Update Log
        env:
          GH_TOKEN: ${{ github.token }}
          TAG: ${{ needs.check-version.outputs.latest_tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "$TAG" > log
          git add log
          git commit -m "chore: update log to $TAG" || echo "No changes to commit"
          git push

          gh release create "$TAG" \
            --title "$TAG" \
            --notes "Update to Vaultwarden [$TAG](https://github.com/dani-garcia/vaultwarden/releases/tag/$TAG)" \
            artifacts/*.tar.gz
